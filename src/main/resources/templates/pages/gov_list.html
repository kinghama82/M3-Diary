<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">

<head>
	<meta charset="UTF-8">
	<title>정부정책리스트</title>
</head>

<body>
	<div layout:fragment="content" class="container my-5">
		<div>
			<div class="mb-2">
				<!-- 드롭다운 메뉴 -->
				<select id="regionSelect">
					<option value="">지역 선택(전체)</option>
					<optgroup label="특별시">
						<option value="11000">서울특별시</option>
					</optgroup>
					<optgroup label="광역시">
						<option value="26000">부산광역시</option>
						<option value="27000">대구광역시</option>
						<option value="28000">인천광역시</option>
						<option value="29000">광주광역시</option>
						<option value="30000">대전광역시</option>
						<option value="31000">울산광역시</option>
						<option value="36110">세종특별자치시</option>
					</optgroup>
					<optgroup label="도">
						<option value="41000">경기도</option>
						<option value="42000">강원특별자치도</option>
						<option value="43000">충청북도</option>
						<option value="44000">충청남도</option>
						<option value="45000">전북특별자치도</option>
						<option value="46000">전라남도</option>
						<option value="47000">경상북도</option>
						<option value="48000">경상남도</option>
						<option value="50000">제주특별자치도</option>
					</optgroup>
				</select>
			</div>

			<table style="width: 100%;">
				<thead>
					<tr class="text-center">
						<th class="border border-black">번호</th>
						<th class="border border-black">정책 이름</th>
						<th class="border border-black">신청 기간</th>
						<th class="border border-black">담당 기관</th>
						<th class="border border-black">즐겨 찾기</th>
					</tr>
				</thead>
				<tbody>
					<script>
						function loadPage(page = 1, zipCd= "") {
							const url = zipCd ? `/api/gov/list?page=${page}&zipCd=${zipCd}` : `/api/gov/list?page=${page}`;
							axios.get(url)
								.then(function (response) {
									const items = response.data.result.youthPolicyList;
									const totCount = response.data.result.pagging.totCount;
									const pageSize = 10;
									const totalPages = Math.ceil(totCount / pageSize);

									const tbody = document.querySelector("tbody");
									tbody.innerHTML = "";

									items.forEach((item, index) => {
										const tr = document.createElement("tr");
										tr.classList.add("text-center");
										tr.innerHTML = `
										<td class="border border-black">${(page - 1) * 10 + index + 1}</td>
										<td class="border border-black">
											<a href="https://www.youthcenter.go.kr/youthPolicy/ythPlcyTotalSearch/ythPlcyDetail/${item.plcyNo}" 
												class="text-decoration-none" target="_blank">
												${item.plcyNm}
											</a>
										</td>
										<td class="border border-black">${item.aplyYmd || '-'}</td>
										<td class="border border-black">${item.rgtrHghrkInstCdNm || '-'}</td>
										<td class="border border-black">
											<button class="bookmark-btn"
												data-plcyno="${item.plcyNo}"
												data-plcynm="${item.plcyNm}"
												data-aplyymd="${item.aplyYmd}">
												⭐
											</button>
										</td>
									`;
										tbody.appendChild(tr);
									});

									// 페이지네이션
									const pagination = document.getElementById("pagination");
									pagination.innerHTML = "";

									const groupSize = 10;
									const currentGroup = Math.floor((page - 1) / groupSize);
									const start = currentGroup * groupSize + 1;
									const end = Math.min(start + groupSize - 1, totalPages);

									const nav = document.createElement("nav");
									const ul = document.createElement("ul");
									ul.className = "pagination justify-content-center flex-wrap";

									// 이전
									if (start > 1) {
										const li = document.createElement("li");
										li.className = "page-item";
										li.innerHTML = `<a class="page-link" href="#">«</a>`;
										li.addEventListener("click", () => loadPage(start - 1, zipCd));
										ul.appendChild(li);
									}

									// 페이지 번호
									for (let i = start; i <= end; i++) {
										const li = document.createElement("li");
										li.className = "page-item" + (i === page ? " active" : "");
										li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
										li.addEventListener("click", () => loadPage(i, zipCd));
										ul.appendChild(li);
									}

									// 다음
									if (end < totalPages) {
										const li = document.createElement("li");
										li.className = "page-item";
										li.innerHTML = `<a class="page-link" href="#">»</a>`;
										li.addEventListener("click", () => loadPage(end + 1, zipCd));
										ul.appendChild(li);
									}

									nav.appendChild(ul);
									pagination.appendChild(nav);
								})
								.catch(function (error) {
									console.error("정책 리스트 불러오기 실패:", error);
								});
						}

						document.addEventListener("DOMContentLoaded", function () {
							loadPage(1); // 첫 페이지 로딩
							
							// 드롭다운 변경 시
							const regionSelect = document.getElementById("regionSelect");
							regionSelect.addEventListener("change", () => {
								const selectedZipCd = regionSelect.value;
								loadPage(1, selectedZipCd); // 지역 변경 시 1페이지부터 다시
							});
						});
						
						// 즐겨찾기 버튼 클릭 이벤트 처리
						document.addEventListener("click", function (e) {
							if (e.target.classList.contains("bookmark-btn")) {
								const btn = e.target;
								const data = {
									plcyNo: btn.dataset.plcyno,
									plcyNm: btn.dataset.plcynm,
									aplyYmd: btn.dataset.aplyymd
								};

								axios.post("/api/gov/bookmark", data)
									.then((res) => {
										if (res.data === "저장됨") {
											alert("즐겨찾기에 추가되었습니다.");
											btn.textContent = "저장됨";
											btn.classList.add("btn-secondary");
										} else {
											alert("⭐ 즐겨찾기에서 제거되었습니다.");
											btn.textContent = "⭐";
											btn.classList.remove("btn-secondary");
										}
									})
									.catch(() => {
										alert("즐겨찾기 요청 실패");
									});
							}
						});

					</script>
				</tbody>
			</table>
			<div id="pagination" class="text-center my-4"></div>
		</div>
	</div>
</body>

</html>