name: Deploy via Git Clone on EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Decode PEM key
      run: |
        echo "${{ secrets.EC2_KEY }}" | base64 -d > ec2-key.pem
        chmod 600 ec2-key.pem

    - name: SSH and Deploy
      run: |
        ssh -i ec2-key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
          # í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
          sudo apt update
          sudo apt install -y openjdk-21-jdk
          sudo apt install -y git

          # git clone (ì—†ìœ¼ë©´)
          if [ ! -d "M3-Diary" ]; then
            git clone https://github.com/${{ secrets.REPO_URL }} M3-Diary
          fi

          cd M3-Diary

          # ìµœì‹  ì½”ë“œë¡œ ì—…ë°ì´íŠ¸
          git pull origin main

          # gradle ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ìƒëžµ + ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬)
          chmod +x ./gradlew
          ./gradlew clean build -x test
  
          # JAR ë°±ì—…
          mkdir -p ~/backup
          if [ -f build/libs/M3-Diary-0.0.1-SNAPSHOT.jar ]; then
          cp build/libs/M3-Diary-0.0.1-SNAPSHOT.jar ~/backup/prev.jar
          fi

          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (ìžˆìœ¼ë©´)
          pkill -f 'java -jar' || true

          # ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
          nohup java -jar build/libs/M3-Diary-0.0.1-SNAPSHOT.jar > app.log 2>&1 &
          sleep 10
  
          # í—¬ìŠ¤ì²´í¬
          if curl -s --fail http://localhost:8080/health; then
          echo "âœ… ë°°í¬ ì„±ê³µ" >> app.log
          else
          echo "âŒ ë°°í¬ ì‹¤íŒ¨. ë¡¤ë°± ì¤‘..." >> app.log
          pkill -f 'java -jar' || true
          nohup java -jar ~/backup/prev.jar > app.log 2>&1 &
          echo "ðŸ” ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±ë¨" >> app.log
          fi
  
  
          tail -n 100 app.log
        EOF
