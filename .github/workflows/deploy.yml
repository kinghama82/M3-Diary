name: Deploy via Git Clone on EC2

on:
  push:
    branches:
      - main  # main ë¸Œëžœì¹˜ì— push ë  ë•Œë§ˆë‹¤ ë°°í¬ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest  # ê¹ƒí—ˆë¸Œ ì•¡ì…˜ì´ ì‚¬ìš©í•  ê°€ìƒí™˜ê²½ ì§€ì •

    steps:
    - name: Decode PEM key  # EC2 ì ‘ì†ì„ ìœ„í•œ PEM í‚¤ ë³µí˜¸í™”
      run: |
        echo "${{ secrets.EC2_KEY }}" | base64 -d > ec2-key.pem
        chmod 600 ec2-key.pem

    - name: SSH and Deploy
      run: |
        ssh -i ec2-key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'

          # í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ì„œë²„ ì´ˆê¸° ì„¸íŒ… ëŒ€ë¹„)
          sudo apt update
          sudo apt install -y openjdk-21-jdk git

          # í”„ë¡œì íŠ¸ê°€ ì—†ë‹¤ë©´ git clone
          if [ ! -d "M3-Diary" ]; then
            git clone https://github.com/${{ secrets.REPO_URL }} M3-Diary
          fi

          # í”„ë¡œì íŠ¸ í´ë” ì´ë™
          cd M3-Diary
 
          git update-index --assume-unchanged .env
 

          # ìµœì‹  ì½”ë“œë¡œ ì—…ë°ì´íŠ¸
          git pull origin main

          # ==========================
          # ë¹Œë“œ ì „ ì •ë¦¬ ìž‘ì—… ì‹œìž‘
          # ==========================

          # ê¸°ì¡´ ë¹Œë“œ í´ë” ì‚­ì œ (ë””ìŠ¤í¬ ìš©ëŸ‰ í™•ë³´)
          rm -rf build

          # ê¸°ì¡´ ë¡œê·¸ íŒŒì¼ ì‚­ì œ (ëˆ„ì  ë°©ì§€)
          rm -f app.log

          # ==========================
          # ë¹Œë“œ ì‹œìž‘
          # ==========================

          # gradle ë¹Œë“œ ì¤€ë¹„
          chmod +x ./gradlew

          # í…ŒìŠ¤íŠ¸ ìƒëžµí•˜ê³  ë¹Œë“œ ì‹¤í–‰
          ./gradlew clean build -x test

          # ==========================
          # JAR íŒŒì¼ ë°±ì—…
          # ==========================

          mkdir -p ~/backup  # backup í´ë” ì—†ìœ¼ë©´ ìƒì„±

          if [ -f build/libs/M3-Diary-0.0.1-SNAPSHOT.jar ]; then
            cp build/libs/M3-Diary-0.0.1-SNAPSHOT.jar ~/backup/prev.jar
          fi

          # ==========================
          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ë° ìž¬ì‹œìž‘
          # ==========================

          pkill -f 'java -jar' || true  # ì‹¤í–‰ ì¤‘ì´ë˜ ì„œë²„ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (ì—†ìœ¼ë©´ ë¬´ì‹œ)

          # ìƒˆ JAR íŒŒì¼ë¡œ ì„œë²„ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œ)
          nohup java -jar build/libs/M3-Diary-0.0.1-SNAPSHOT.jar > app.log 2>&1 &
          sleep 10  # ì„œë²„ ê¸°ë™ ëŒ€ê¸°

          # ==========================
          # í—¬ìŠ¤ì²´í¬ ë° ë¡¤ë°± ì²˜ë¦¬
          # ==========================

          if curl -s --fail http://localhost:8080/health; then
            echo "âœ… ë°°í¬ ì„±ê³µ" >> app.log
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨. ë¡¤ë°± ì¤‘..." >> app.log
            pkill -f 'java -jar' || true
            nohup java -jar ~/backup/prev.jar > app.log 2>&1 &
            echo "ðŸ” ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±ë¨" >> app.log
          fi

          # ==========================
          # ìµœê·¼ ë¡œê·¸ ì¶œë ¥
          # ==========================

          tail -n 100 app.log

        EOF
