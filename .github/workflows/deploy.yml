name: Deploy via Git Clone on EC2

on:
  push:
    branches:
      - main  # main ë¸Œëžœì¹˜ì— push ë  ë•Œë§ˆë‹¤ ë°°í¬ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest  # ê¹ƒí—ˆë¸Œ ì•¡ì…˜ì´ ì‚¬ìš©í•  ê°€ìƒí™˜ê²½ ì§€ì •

    steps:
    - name: Decode PEM key  # EC2 ì ‘ì†ì„ ìœ„í•œ PEM í‚¤ ë³µí˜¸í™”
      run: |
        echo "${{ secrets.EC2_KEY }}" | base64 -d > ec2-key.pem
        chmod 600 ec2-key.pem

    - name: SSH and Deploy
      run: |
        ssh -i ec2-key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'

          # íŒ¨í‚¤ì§€ ì„¤ì¹˜
          sudo apt update
          sudo apt install -y openjdk-21-jdk git

          # í”„ë¡œì íŠ¸ ì—†ìœ¼ë©´ clone
          if [ ! -d "M3-Diary" ]; then
            git clone https://github.com/${{ secrets.REPO_URL }} M3-Diary
          fi

          cd M3-Diary

          # .env ì¶©ëŒ ë°©ì§€
          git restore --staged .env || true
          git checkout -- .env || true
          git update-index --assume-unchanged .env

          # ìµœì‹  ì½”ë“œ ë°˜ì˜
          git pull origin main

          # ë¹Œë“œ ì „ ì •ë¦¬
          rm -rf build
          rm -f app.log

          # ë¹Œë“œ
          chmod +x ./gradlew
          ./gradlew clean build -x test

          # ë¹Œë“œ ì„±ê³µ í›„ì—ë§Œ JAR ë°±ì—…
          if [ -f build/libs/M3-Diary-0.0.1-SNAPSHOT.jar ]; then
            mkdir -p ~/backup
            cp build/libs/M3-Diary-0.0.1-SNAPSHOT.jar ~/backup/prev.jar
          fi

          # âœ… systemd ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ìœ¼ë¡œ ìµœì‹  JAR ë°˜ì˜
          echo "ðŸ”„ ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ ì¤‘..."
          sudo systemctl restart m3-diary.service
          sleep 3

          # âœ… í—¬ìŠ¤ì²´í¬ ë£¨í”„ (ìµœëŒ€ 30ì´ˆ, 3ì´ˆ ê°„ê²©)
          for i in {1..10}; do
            if curl -s --fail http://localhost:8080/health; then
              echo "âœ… ì„œë²„ í™œì„±í™”ë¨" >> app.log
              break
            else
              echo "â³ ì„œë²„ ê¸°ë™ ëŒ€ê¸° ì¤‘... ($i/10)" >> app.log
              sleep 3
            fi
          done

          # ë¡œê·¸ ì¶œë ¥
          tail -n 100 app.log

        EOF
